$(document).on("ready page:load", function() {

  var media = <%= PlayerTrack.audio_urls %>;

  var trackTitles = <%= PlayerTrack.titles %>;

  var currentTrack = media[0];

  // Instantiate jPlayer
  $("div#my-jplayer").jPlayer({
    ready: setMedia,
    ended: playNextTrack,
    swfPath: "/",
    supplied: "mp3",
    cssSelectorAncestor: "div#audio-controls",
    cssSelector: {
      play: "div#play-container",
      pause: "div#pause-container"
    },
    preload: "auto",
    keyEnabled: true
  });

  $("div#prev").click(playPrevTrack);
  $("div#next").click(playNextTrack);

  function playPrevTrack() {
    currentTrack = media[prevTrackIndex()];
    setMedia({ play: true });
  }

  function playNextTrack() {
    currentTrack = media[nextTrackIndex()];
    setMedia({ play: true });
  }

  function setMedia(options) {
    $("span#track-title").text(trackTitle());
    $("div#my-jplayer").jPlayer("setMedia", {
      mp3: currentTrack
    });
    if (options.play) {
      $("div#my-jplayer").jPlayer("play");
    }
  }

  function prevTrackIndex() {
    return trackIndex() == 0 ? media.length - 1 : trackIndex() - 1;
  }

  function nextTrackIndex() {
    return trackIndex() == media.length - 1 ? 0 : trackIndex() + 1;
  }

  function trackIndex() {
    return media.indexOf(currentTrack);
  }

  function trackTitle() {
    return trackTitles[trackIndex()];
  }

});